alter table lookup_province add column cod_provincia text;
alter table lookup_province add column cod_nazione text;


update lookup_province set cod_provincia='CL', cod_nazione='106' where code=85;
update lookup_province set cod_provincia='CB', cod_nazione='106' where code=70;
update lookup_province set cod_provincia='CT', cod_nazione='106' where code=87;
update lookup_province set cod_provincia='CZ', cod_nazione='106' where code=79;
update lookup_province set cod_provincia='CH', cod_nazione='106' where code=69;
update lookup_province set cod_provincia='CO', cod_nazione='106' where code=13;
update lookup_province set cod_provincia='CS', cod_nazione='106' where code=78;
update lookup_province set cod_provincia='CR', cod_nazione='106' where code=19;
update lookup_province set cod_provincia='KR', cod_nazione='106' where code=101;
update lookup_province set cod_provincia='CN', cod_nazione='106' where code=4;
update lookup_province set cod_provincia='EN', cod_nazione='106' where code=86;
update lookup_province set cod_provincia='TN', cod_nazione='106' where code=22;
update lookup_province set cod_provincia='TV', cod_nazione='106' where code=26;
update lookup_province set cod_provincia='TS', cod_nazione='106' where code=32;
update lookup_province set cod_provincia='UD', cod_nazione='106' where code=30;
update lookup_province set cod_provincia='VA', cod_nazione='106' where code=12;
update lookup_province set cod_provincia='VE', cod_nazione='106' where code=27;
update lookup_province set cod_provincia='VC', cod_nazione='106' where code=2;
update lookup_province set cod_provincia='BN', cod_nazione='106' where code=62;
update lookup_province set cod_provincia='CE', cod_nazione='106' where code=61;
update lookup_province set cod_provincia='AV', cod_nazione='106' where code=64;
update lookup_province set cod_provincia='SP', cod_nazione='106' where code=11;
update lookup_province set cod_provincia='BZ', cod_nazione='106' where code=21;
update lookup_province set cod_provincia='RE', cod_nazione='106' where code=35;
update lookup_province set cod_provincia='FC', cod_nazione='106' where code=40;
update lookup_province set cod_provincia='PU', cod_nazione='106' where code=41;
update lookup_province set cod_provincia='AP', cod_nazione='106' where code=44;
update lookup_province set cod_provincia='RC', cod_nazione='106' where code=80;
update lookup_province set cod_provincia='VV', cod_nazione='106' where code=102;
update lookup_province set cod_provincia='VB', cod_nazione='106' where code=103;
update lookup_province set cod_provincia='OT', cod_nazione='106' where code=104;
update lookup_province set cod_provincia='CI', cod_nazione='106' where code=107;
update lookup_province set cod_provincia='MB', cod_nazione='106' where code=108;
update lookup_province set cod_provincia='AG', cod_nazione='106' where code=84;
update lookup_province set cod_provincia='AL', cod_nazione='106' where code=6;
update lookup_province set cod_provincia='AN', cod_nazione='106' where code=42;
update lookup_province set cod_provincia='AQ', cod_nazione='106' where code=66;
update lookup_province set cod_provincia='AR', cod_nazione='106' where code=51;
update lookup_province set cod_provincia='AT', cod_nazione='106' where code=5;
update lookup_province set cod_provincia='BA', cod_nazione='106' where code=72;
update lookup_province set cod_provincia='BT', cod_nazione='106' where code=110;
update lookup_province set cod_provincia='BL', cod_nazione='106' where code=25;
update lookup_province set cod_provincia='BG', cod_nazione='106' where code=16;
update lookup_province set cod_provincia='BI', cod_nazione='106' where code=96;
update lookup_province set cod_provincia='BO', cod_nazione='106' where code=37;
update lookup_province set cod_provincia='BS', cod_nazione='106' where code=17;
update lookup_province set cod_provincia='BR', cod_nazione='106' where code=74;
update lookup_province set cod_provincia='CA', cod_nazione='106' where code=92;
update lookup_province set cod_provincia='VR', cod_nazione='106' where code=23;
update lookup_province set cod_provincia='VI', cod_nazione='106' where code=24;
update lookup_province set cod_provincia='VT', cod_nazione='106' where code=56;
update lookup_province set cod_provincia='NA', cod_nazione='106' where code=63;
update lookup_province set cod_provincia='SA', cod_nazione='106' where code=65;
update lookup_province set cod_provincia='AO', cod_nazione='106' where code=7;
update lookup_province set cod_provincia='FM', cod_nazione='106' where code=109;
update lookup_province set cod_provincia='FE', cod_nazione='106' where code=38;
update lookup_province set cod_provincia='FI', cod_nazione='106' where code=48;
update lookup_province set cod_provincia='FG', cod_nazione='106' where code=71;
update lookup_province set cod_provincia='FR', cod_nazione='106' where code=60;
update lookup_province set cod_provincia='GE', cod_nazione='106' where code=10;
update lookup_province set cod_provincia='GO', cod_nazione='106' where code=31;
update lookup_province set cod_provincia='GR', cod_nazione='106' where code=53;
update lookup_province set cod_provincia='IM', cod_nazione='106' where code=8;
update lookup_province set cod_provincia='IS', cod_nazione='106' where code=94;
update lookup_province set cod_provincia='LT', cod_nazione='106' where code=59;
update lookup_province set cod_provincia='LE', cod_nazione='106' where code=75;
update lookup_province set cod_provincia='LC', cod_nazione='106' where code=97;
update lookup_province set cod_provincia='LI', cod_nazione='106' where code=49;
update lookup_province set cod_provincia='LO', cod_nazione='106' where code=98;
update lookup_province set cod_provincia='LU', cod_nazione='106' where code=46;
update lookup_province set cod_provincia='MC', cod_nazione='106' where code=43;
update lookup_province set cod_provincia='MN', cod_nazione='106' where code=20;
update lookup_province set cod_provincia='MS', cod_nazione='106' where code=45;
update lookup_province set cod_provincia='MT', cod_nazione='106' where code=77;
update lookup_province set cod_provincia='VS', cod_nazione='106' where code=106;
update lookup_province set cod_provincia='ME', cod_nazione='106' where code=83;
update lookup_province set cod_provincia='MI', cod_nazione='106' where code=15;
update lookup_province set cod_provincia='MO', cod_nazione='106' where code=36;
update lookup_province set cod_provincia='NO', cod_nazione='106' where code=3;
update lookup_province set cod_provincia='NU', cod_nazione='106' where code=91;
update lookup_province set cod_provincia='OG', cod_nazione='106' where code=105;
update lookup_province set cod_provincia='OR', cod_nazione='106' where code=95;
update lookup_province set cod_provincia='PD', cod_nazione='106' where code=28;
update lookup_province set cod_provincia='PA', cod_nazione='106' where code=82;
update lookup_province set cod_provincia='PR', cod_nazione='106' where code=34;
update lookup_province set cod_provincia='PV', cod_nazione='106' where code=18;
update lookup_province set cod_provincia='PG', cod_nazione='106' where code=54;
update lookup_province set cod_provincia='PE', cod_nazione='106' where code=68;
update lookup_province set cod_provincia='PC', cod_nazione='106' where code=33;
update lookup_province set cod_provincia='PI', cod_nazione='106' where code=50;
update lookup_province set cod_provincia='PT', cod_nazione='106' where code=47;
update lookup_province set cod_provincia='PN', cod_nazione='106' where code=93;
update lookup_province set cod_provincia='PZ', cod_nazione='106' where code=76;
update lookup_province set cod_provincia='PO', cod_nazione='106' where code=100;
update lookup_province set cod_provincia='RG', cod_nazione='106' where code=88;
update lookup_province set cod_provincia='RA', cod_nazione='106' where code=39;
update lookup_province set cod_provincia='RI', cod_nazione='106' where code=57;
update lookup_province set cod_provincia='RN', cod_nazione='106' where code=99;
update lookup_province set cod_provincia='RO', cod_nazione='106' where code=29;
update lookup_province set cod_provincia='SS', cod_nazione='106' where code=90;
update lookup_province set cod_provincia='SV', cod_nazione='106' where code=9;
update lookup_province set cod_provincia='SI', cod_nazione='106' where code=52;
update lookup_province set cod_provincia='SR', cod_nazione='106' where code=89;
update lookup_province set cod_provincia='SO', cod_nazione='106' where code=14;
update lookup_province set cod_provincia='TA', cod_nazione='106' where code=73;
update lookup_province set cod_provincia='TE', cod_nazione='106' where code=67;
update lookup_province set cod_provincia='TR', cod_nazione='106' where code=55;
update lookup_province set cod_provincia='TO', cod_nazione='106' where code=1;
update lookup_province set cod_provincia='TP', cod_nazione='106' where code=81;
update lookup_province set cod_provincia='Rm', cod_nazione='106' where code=58;


CREATE TYPE impresa AS
   (id integer,
    partita_iva text,
    codice_fiscale_impresa text,
    ragione_sociale text,
    note text,
    domicilio_digitale text,
    tipo_impresa integer,
    tipo_societa integer,
    id_indirizzo integer,
    enteredby integer,
    modifiedby integer,
    id_soggetto_fisico integer,
    id_esito integer);
ALTER TYPE impresa
  OWNER TO postgres;


CREATE TYPE persona AS
   (id integer,
    cognome text,
    nome text,
    cf text,
    comune_nascita text,
    sesso character(1),
    email text,
    data_nascita timestamp without time zone,
    id_indirizzo integer,
    trashed_date timestamp without time zone,
    inserito_da integer,
    modificato_da integer,
    data_inserimento timestamp without time zone,
    data_modifica timestamp without time zone);
ALTER TYPE persona
  OWNER TO postgres;

-- Function: public_functions.insert_soggetto_fisico_bdu(text, text, text, timestamp without time zone, text, text, text, text, text, text, text, text, text, integer)

-- DROP FUNCTION public_functions.insert_soggetto_fisico_bdu(text, text, text, timestamp without time zone, text, text, text, text, text, text, text, text, text, integer);

CREATE OR REPLACE FUNCTION public_functions.insert_soggetto_fisico_bdu(nome_rapp_sede_legale_out text, cognome_rapp_sede_legale_out text, cf_rapp_sede_legale_out text, data_nascita_rapp_sede_legale_out timestamp without time zone, sesso_out text, comune_nascita_rapp_sede_legale_out text, sigla_prov_soggfisico_out text, comune_residenza_out text, indirizzo_rapp_sede_legale_out text, toponimo_out text, civico_residenza_out text, cap_residenza text, nazione_residenza text, idutente integer)
  RETURNS integer AS
$BODY$
DECLARE
id_soggetto_fisico int ;
nome_rapp_sede_legale_temp text ;
cognome_rapp_sede_legale_temp text;
cf_rapp_sede_legale_temp text;
data_nascita_rapp_sede_legale_temp timestamp;
sesso_temp text;
comune_nascita_rapp_sede_legale_temp text ;
id_indirizzo int ;
BEGIN
FOR
id_soggetto_fisico,
cognome_rapp_sede_legale_temp ,
nome_rapp_sede_legale_temp  ,
comune_nascita_rapp_sede_legale_temp  ,
data_nascita_rapp_sede_legale_temp ,
cf_rapp_sede_legale_temp ,
sesso_temp 
IN
/*RECUPERO SOGGETTO DA ANAGRAFICA UFFICIALE SE ESISTE*/
select s.id,cognome,nome,comune_nascita,data_nascita,codice_fiscale,sesso
from opu_soggetto_fisico s where s.codice_fiscale ilike trim(cf_rapp_sede_legale_out)
LOOP
if 	upper(trim(nome_rapp_sede_legale_temp))=upper(trim(nome_rapp_sede_legale_out)) and 
	upper(trim(cognome_rapp_sede_legale_temp))=upper(trim(cognome_rapp_sede_legale_out)) and
	data_nascita_rapp_sede_legale_temp=data_nascita_rapp_sede_legale_out and
	upper(trim(sesso_temp))=upper(trim(sesso_out)) and
	upper(trim(comune_nascita_rapp_sede_legale_temp))=upper(trim(comune_nascita_rapp_sede_legale_out)) 
	/* SE  TUTTI  CAMPI SONO UGUALI RITORNO QUELLO ESISTENTE */
then	
return id_soggetto_fisico ;
end if ;
end loop ;

id_soggetto_fisico:=(select nextval('opu_soggetto_fisico_id_seq'));

select * into id_indirizzo from public_functions.suap_convergenza_indirizzo(sigla_prov_soggfisico_out, comune_residenza_out, indirizzo_rapp_sede_legale_out, toponimo_out,
civico_residenza_out, cap_residenza, nazione_residenza) ;

insert into opu_soggetto_fisico (id,cognome,nome,comune_nascita,data_nascita,codice_fiscale,indirizzo_id,sesso,enteredby,modifiedby)
values ( id_soggetto_fisico , cognome_rapp_sede_legale_out ,nome_rapp_sede_legale_out , comune_nascita_rapp_sede_legale_out
,data_nascita_rapp_sede_legale_out, cf_rapp_sede_legale_out,id_indirizzo,sesso_out,idutente,idutente);
return  id_soggetto_fisico;	
 END;
$BODY$
  LANGUAGE plpgsql VOLATILE STRICT
  COST 100;
ALTER FUNCTION public_functions.insert_soggetto_fisico_bdu(text, text, text, timestamp without time zone, text, text, text, text, text, text, text, text, text, integer)
  OWNER TO postgres;

-- Function: public_functions.suap_insert_impresa_bdu(integer, character varying, character varying, character varying, text, text, text, text, text, text, text)

-- DROP FUNCTION public_functions.suap_insert_impresa_bdu(integer, character varying, character varying, character varying, text, text, text, text, text, text, text);

CREATE OR REPLACE FUNCTION public_functions.suap_insert_impresa_bdu(id_soggetto_fisico_in integer, partita_iva_in character varying, codice_fiscale_impresa_in character varying, ragione_sociale_in character varying, sigla_prov_sede_legale text, comune_sede_legale text, indirizzo_legale text, toponimo text, civico_legale text, cap_legale text, nazione_legale text)
  RETURNS impresa AS
$BODY$
DECLARE

opu_impresa impresa ;
occorrenzeEsistenti integer  ;
numIndirizzi integer; 
impresa_id integer;
suap_id_sede integer;
id_indirizzo integer;
BEGIN
occorrenzeEsistenti:=0;
opu_impresa.id_esito:=1; /*NON ESISTENTE*/
/*CONTROLLO SE L'IMPRESA ESISTE IN OPU*/

for 
opu_impresa.id, opu_impresa.partita_iva,opu_impresa.codice_fiscale_impresa,opu_impresa.ragione_sociale
 IN
select opu_operatore.id,partita_iva,codice_fiscale_impresa,ragione_sociale 
from  opu_operatore
join opu_rel_operatore_soggetto_fisico rel on rel.id_operatore=opu_operatore.id --and rel.enabled
where (opu_operatore.partita_iva=partita_iva_in or opu_operatore.codice_fiscale_impresa = codice_fiscale_impresa_in) and opu_operatore.trashed_date is null 
and rel.tipo_soggetto_fisico=2 and rel.stato_ruolo=1 and rel.id_soggetto_fisico=id_soggetto_fisico_in

LOOP
occorrenzeEsistenti:=occorrenzeEsistenti+1;
	numIndirizzi:=(select count(*) from(select  distinct upper (trim(via)) ,upper (trim(cap)),upper (trim(provincia)),comune
	from opu_indirizzo where id in(select sede.id_indirizzo from opu_relazione_operatore_sede sede where sede.id_operatore = opu_impresa.id ))a);
	
raise info 'numIndirizzi : %',numIndirizzi;
/*SE ESISTE UNA IMPRESACON GLI STESSI DATI NON LA  INSERISCO E RITORNO QUELLA ESISTENTE*/
if 	partita_iva_in=opu_impresa.partita_iva and 
	codice_fiscale_impresa_in = opu_impresa.codice_fiscale_impresa and 
	ragione_sociale_in=opu_impresa.ragione_sociale and 
        numIndirizzi=1
then	
	return opu_impresa ;
end if;	
numIndirizzi:=0;
	
	END LOOP;

impresa_id:=(select nextval('opu_operatore_id_seq'));

insert into opu_operatore (id,partita_iva,codice_fiscale_impresa,ragione_sociale,enteredby,modifiedby,entered,modified)
values (
impresa_id,
partita_iva_in,
codice_fiscale_impresa_in,
ragione_sociale_in,
0,
0,current_timestamp,current_timestamp
);

--inserimento del record di relazione tra soggetto_fisico e id_operatore
insert into opu_rel_operatore_soggetto_fisico (id_soggetto_fisico,id_operatore,tipo_soggetto_fisico,data_inizio,stato_ruolo)
values(id_soggetto_fisico_in,impresa_id,2,current_timestamp,1);	

--verifico esistenza id_indirizzo sede legale
select * into id_indirizzo from public_functions.suap_convergenza_indirizzo(sigla_prov_sede_legale, comune_sede_legale, indirizzo_legale, toponimo, civico_legale, cap_legale, nazione_legale);

suap_id_sede :=(select nextval('opu_relazione_operatore_sede_id_seq'));
--da approfondire stato e tipologia sede

insert into opu_relazione_operatore_sede(id,id_operatore,id_indirizzo,tipologia_sede,stato_sede)
values(suap_id_sede, impresa_id,id_indirizzo,1,1);	

return opu_impresa ;

 END;
$BODY$
  LANGUAGE plpgsql VOLATILE STRICT
  COST 100;
ALTER FUNCTION public_functions.suap_insert_impresa_bdu(integer, character varying, character varying, character varying, text, text, text, text, text, text, text)
  OWNER TO postgres;

-- Function: public_functions.suap_inserisci_stabilimento_bdu(integer, integer, text, text, text, text, text, text, text)

-- DROP FUNCTION public_functions.suap_inserisci_stabilimento_bdu(integer, integer, text, text, text, text, text, text, text);

CREATE OR REPLACE FUNCTION public_functions.suap_inserisci_stabilimento_bdu(id_operatore_in integer, id_asl_in integer, prov_stabilimento text, comune_stabilimento text, indirizzo_stabilimento text, toponimo text, civico_stailimento text, cap_stabilimento text, nazione_stabilimento text)
  RETURNS integer AS
$BODY$
DECLARE
idStabilimento int ;
id_stabilimento_opu integer;
id_indirizzo_out integer;
opu_impresa impresa;

BEGIN

select * into id_indirizzo_out from public_functions.suap_convergenza_indirizzo(prov_stabilimento, comune_stabilimento, indirizzo_stabilimento, toponimo,
civico_stailimento, cap_stabilimento, nazione_stabilimento);

for 
opu_impresa.partita_iva,opu_impresa.id,id_stabilimento_opu
 IN
/*VERIFICO SE PER QUELLA PARTITA IVA ESISTE UNO STABILIMENTO A QUELL'INDIRIZZO*/
select opu.partita_iva, opu.id, os.id 
from opu_operatore opu 
join opu_stabilimento os on os.id_operatore=opu.id 
where opu.id=id_operatore_in and os.id_indirizzo = id_indirizzo_out

LOOP
/*SE ESISTE LO STABILIMENTO PARTITA IVA ED INDIRIZZO, LA FUNZIONE TERMINA */
if id_stabilimento_opu>0
then 
	return id_stabilimento_opu;
end if;

END LOOP;
idStabilimento:=(select nextval('opu_stabilimento_id_seq'));
insert into opu_stabilimento (id,id_operatore,id_asl,id_indirizzo,entered_by,modified_by,entered,modified)
values
(
idStabilimento,id_operatore_in,id_asl_in,id_indirizzo_out,0,0,current_Timestamp,current_timestamp
);

return idStabilimento;

 END;
$BODY$
  LANGUAGE plpgsql VOLATILE STRICT
  COST 100;
ALTER FUNCTION public_functions.suap_inserisci_stabilimento_bdu(integer, integer, text, text, text, text, text, text, text)
  OWNER TO postgres;

-- Function: public_functions.suap_insert_linea_produttiva(integer, integer)

-- DROP FUNCTION public_functions.suap_insert_linea_produttiva(integer, integer);


CREATE OR REPLACE FUNCTION public_functions.suap_insert_linea_produttiva(id_linea_prod integer, id_stabilimento integer)
  RETURNS integer AS
$BODY$
BEGIN

insert into opu_relazione_stabilimento_linee_produttive (id_linea_produttiva,id_stabilimento)
values(id_linea_prod,id_stabilimento);
return id_stabilimento ;

 END;
$BODY$
  LANGUAGE plpgsql VOLATILE STRICT
  COST 100;
ALTER FUNCTION public_functions.suap_insert_linea_produttiva(integer, integer)
  OWNER TO postgres;

CREATE OR REPLACE FUNCTION public_functions.suap_inserisci_canile_bdu(partita_iva character varying, codice_fiscale_impresa character varying, ragione_sociale text, nome_rapp_sede_legale_out text, cognome_rapp_sede_legale_out text, cf_rapp_sede_legale_out text, data_nascita_rapp_sede_legale_out timestamp without time zone, sesso_out text, comune_nascita_rapp_sede_legale_out text, sigla_prov_soggfisico_out text, comune_residenza_out text, indirizzo_rapp_sede_legale_out text, civico_residenza_out text, cap_residenza text, nazione_residenza text, sigla_provincia_legale text, comune_legale text, indirizzo_legale text, civico_legale text, cap_legale text, nazione_legale text, sigla_provincia_stab text, comune_stab text, indirizzo_stab text, civico_stab text, cap_stab text, nazione_stab text, id_linea_produttiva integer, id_asl_in integer, idutente integer, toponimo_rapp_sede_legale text, toponimo_legale text, toponimo_stab text)
  RETURNS integer AS
$BODY$
DECLARE
id_impresa integer;
id_soggetto_out integer;
id_stab_out integer;
BEGIN
-- 1. soggetto fisico ed indirizzo rappresentante legale che ritorna id_soggetto fisico
id_soggetto_out := (select * from public_functions.insert_soggetto_fisico_bdu(nome_rapp_sede_legale_out,cognome_rapp_sede_legale_out, cf_rapp_sede_legale_out, data_nascita_rapp_sede_legale_out, 
sesso_out,comune_nascita_rapp_sede_legale_out, sigla_prov_soggfisico_out, comune_residenza_out, indirizzo_rapp_sede_legale_out,toponimo_rapp_sede_legale,civico_residenza_out, cap_residenza, nazione_residenza,idutente));
-- 2 impresa in relazione al soggetto fisico e all'indirizzo restituisce una tupla con id operatore partita_iva, ragione sociale e cf...
id_impresa := (select id from public_functions.suap_insert_impresa_bdu(id_soggetto_out,partita_iva,codice_fiscale_impresa,ragione_sociale,sigla_provincia_legale,comune_legale,indirizzo_legale,toponimo_legale,
civico_legale,cap_legale,nazione_legale));
-- 3 stabilimento restituisce l'id dello stabilimento
id_stab_out := (select * from public_functions.suap_inserisci_stabilimento_bdu(id_impresa,id_asl_in,sigla_provincia_stab, comune_stab,indirizzo_stab,toponimo_stab,civico_stab,cap_stab,nazione_stab));
-- 4 linea produttiva, esegue una insert e restituisce un booleano. 5 è un canile, 6 l'operatore commerciale
id_stab_out := (select * from public_functions.suap_insert_linea_produttiva(id_linea_produttiva,id_stab_out));

return id_stab_out;
 END;
$BODY$
  LANGUAGE plpgsql VOLATILE STRICT
  COST 100;
ALTER FUNCTION public_functions.suap_inserisci_canile_bdu(character varying, character varying, text, text, text, text, timestamp without time zone, text, text, text, text, text, text, text, text, text, text, text, text, text, text, text, text, text, text, text, text, integer, integer, integer, text, text, text)
  OWNER TO postgres;
  
  
  
  
  select * from public_functions.update_opu_materializato( #idOperatore );

